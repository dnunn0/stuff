<!DOCTYPE html>
<html>
<head>

    <title>Firefly</title>
    <script>
	var allianceNavPath = "/alliance/nav";
	var allianceNavStatusPath = allianceNavPath + "/status";
	var allianceNavLockPath = allianceNavPath + "/lock";
	var hostPort = "host:port";

	function sendRequest(method, path, callbackProcess, successCallback) {
	  var xhttp = new XMLHttpRequest();
	  xhttp.addEventListener("load", function(ev){callbackProcess(xhttp, successCallback); });
	  xhttp.addEventListener("error", function(ev){updateElement("requestResult", true, "Request probably didn't get to server.");});

	  xhttp.open(method, getUrl(path), true);
	  xhttp.setRequestHeader("Authorize", "dm9yZGVsOnZvcmRlbA==");
	  xhttp.send();
	}

	function getUrl(path) {
		if (!path.startsWith("/")) path = "/" + path;
	  return "http://"+hostPort+ path
	}

	function updateElement(target, addEmphasis, newHtml) {
	  if (addEmphasis) newHtml = "<font color='red'>" + unemphasizedHtml + "</font>";
	  document.getElementById(target).innerHTML = newHtml;
	}

	function processActionResponse(xhttp, target, successCallback) {
		switch (xhttp.status) {
		  case 200:
			successCallback(xhttp, target)
			break;
		  case 404:
			updateElement(target, true, "Needs shuffling!");
			break;
		  case 409:
			updateElement(target, true, "Locked!");
			break;
		  default:
			displayUnexpectedError(xhttp, target);
		}
		updateStatus();

	}

	function processStatusResponse(xhttp, target) {
	    switch (xhttp.status) {
	      case 200:
	        return updateDeckStatus(xhttp, target);
	        break;
	      default:
	        displayUnexpectedError(xhttp, target);
	    }
	}
	
	function displayUnexpectedError(xhttp, target, ev) {
		var result = "Unexpected error: ReadyState, status, text: " + xhttp.readyState + "- " + xhttp.status + "-" + xhttp.statusText + ".";
	    updateElement(target, true, result);
	}
	
	function updateRequestId(xhttp, shouldOverride) {
		var target = "requestId";
		if (shouldOverride || "" == document.getElementById(target).innerHTML)
			updateElement(target, false, xhttp.getResponseHeader("id"));
	}

	function justDisplayResponse(xhttp, target) {
	  var result = xhttp.responseText;
	  updateElement(target, false, result);
	  updateRequestId(xhttp, true);
	}
	
	function updateHistory(card) {
		var item = card.action;
		if (card.hasPic) {
			item = "<a href='"+getUrl(cardPicName(card))+"' target='_blank'>"+ card.action + "</a>";
		}
		updateElement("history", false, "<li>"+item+"</li>" + document.getElementById("history").innerHTML);
	}

	function displayNavCard(xhttp, target) {
	  var card = JSON.parse(xhttp.responseText);
	  var newHtml = card.action;
	  if (card.hasPic) {
		  var picName = cardPicName(card);
		  newHtml = "<br><img src='" + getUrl(picName) 
				+ "' alt='"+card.action+"'"
				+ " height='320' width='220'"
				+"/>";
	  }
	  updateElement(target, false, newHtml);
	  updateRequestId(xhttp, true);
	  updateHistory(card);
	}
	
	function cardPicName(card) {
		return card.action.replace(/[^a-zA-Z]/g, "")+".png";
	}

	function updateDeckStatus(xhttp, target) {
	  var stat = JSON.parse(xhttp.responseText);
	  var result = "Cards Left: " + stat.cardCount;
	  result += "&emsp;Discards: " + stat.discardsCount;
	  result += "&emsp;Is Locked: " + stat.isLocked;
	  //  result += "<br>" + xhttp.responseText
	  //result += "<\p>";
	  updateElement(target, false, result);
	  updateRequestId(xhttp, false);
	  if ("" == document.getElementById("requestResult").innerHTML) updateElement("requestResult", false, "-");


	  var hasCards = stat.cardCount > 0;
	  var isLocked = stat.isLocked;
	  document.getElementById("draw").disabled = !hasCards || isLocked;
	  document.getElementById("shuffle").disabled = isLocked;
	  document.getElementById("unlock").disabled = !isLocked;
	}

	function processActionResponseFun(xhttp, successCallback) {
	  return processActionResponse(xhttp, "requestResult", successCallback);
	}

	function processStatusResponseFun(xhttp) {
	  return processStatusResponse(xhttp, "status");
	}

	function justDisplayResponseFun(xhttp, target) {
	  return justDisplayResponse(xhttp, target);
	}

	function updateStatus() {
	  sendRequest("GET", allianceNavStatusPath, processStatusResponseFun);
	}

	function get(path) {
	  sendRequest("GET", path, processActionResponseFun, displayNavCard);
	}

	function post(path) {
	  sendRequest("POST", path, processActionResponseFun, justDisplayResponse);
	}

	function del(path) {
	  sendRequest("DELETE", path, processActionResponseFun, justDisplayResponse);
	}
	
	function clearHistory() {
		updateElement("history", false, "");
	}

	window.onload = function(e) {
		hostPort="35.166.255.19:24680";
		hostPort="192.168.1.86:4567";
	  hostPort = prompt("Please enter the host:port", hostPort);
	  updateStatus();

	};

    </script>
</head>

<body>


<button id="draw" type="button" onclick="get(allianceNavPath)">Request nav card</button>
<button id="shuffle" type="button" onclick="post(allianceNavPath)">Shuffle</button>
<button id="lock" type="button" onclick="post(allianceNavLockPath)">Lock Deck</button>
<button id="unlock" type="button" onclick="del(allianceNavLockPath)">Unlock Deck</button>
<button id="unlock" type="button" onclick="clearHistory()">Clear History</button>

<p><span id="requestResult"/><br></p>
<p><span id="status"/><br></p>
<p>History
<ol style="margin-top:-10px;"><span id="history"/></ol>
</p>
<p>Request id: <span id="requestId"/><br></p>


</body>
</html>

