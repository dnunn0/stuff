<!DOCTYPE html>
<html>
<head>

    <title>Firefly</title>
    <script>
	var allianceNavPath = "/alliance/nav";
	var allianceNavStatusPath = allianceNavPath + "/status";
	var allianceNavLockPath = allianceNavPath + "/lock";
	var hostPort = "host:port";

	function sendRequest(method, path, callbackProcess, successCallback) {
	  var xhttp = new XMLHttpRequest();
	  xhttp.addEventListener("load", function(ev){callbackProcess(xhttp, successCallback); });
	  xhttp.addEventListener("error", function(ev){updateElement("requestResult", true, "Request probably didn't get to server.");});

	  xhttp.open(method, getUrl(path), true);
	  xhttp.setRequestHeader("Authorize", "dm9yZGVsOnZvcmRlbA==");
	  xhttp.send();
	}

	function getUrl(path) {
	  return "http://"+hostPort+ path
	}

	function updateElement(target, addEmphasis, newInner) {
	  if (addEmphasis) var result = "<font color='red'>" + newInner + "</font>";
	  document.getElementById(target).innerHTML = result;
	}

	function processActionResponse(xhttp, target, successCallback) {
		switch (xhttp.status) {
		  case 200:
			successCallback(xhttp, target)
			break;
		  case 404:
			updateElement(target, true, "Needs shuffling!");
			break;
		  case 409:
			updateElement(target, true, "Locked!");
			break;
		  default:
			displayUnexpectedError(xhttp, target);
		}
		//need to get status in here after the action has completed
		//  because DELETE first sends an OPTION, and then the next GET for *status*,
		//  and only then after that does it send the DELETE. 
		updateStatus();

	}

	function processStatusResponse(xhttp, target) {
	  if (xhttp.readyState == 4) {
	    var result = "none";
	    var addEmphasis = true;
	    switch (xhttp.status) {
	      case 200:
	        return updateDeckStatus(xhttp, target);
	        break;
	      default:
	        displayUnexpectedError(xhttp, target);
	    }
	  }
	}
	
	function displayUnexpectedError(xhttp, target, ev) {
		var result = "Unexpected error: ReadyState, status, text: " + xhttp.readyState + "- " + xhttp.status + "-" + xhttp.statusText + ".";
	    updateElement(target, true, result);

	}
	
	function updateRequestId(xhttp) {
			  document.getElementById("requestId").innerHTML = xhttp.getResponseHeader("id");
	}

	function justDisplayResponse(xhttp, target) {
	  var result = xhttp.responseText;
	  document.getElementById(target).innerHTML = result;
	  updateRequestId(xhttp);
	}

	function displayNavCard(xhttp, target) {
	  var result = JSON.parse(xhttp.responseText).action;
	  document.getElementById(target).innerHTML = result;
	  updateRequestId(xhttp);
	}

	function updateDeckStatus(xhttp, target) {
	  var stat = JSON.parse(xhttp.responseText);
	  var result = "Cards: " + stat.cardCount;
	  result += "<br>Discards: " + stat.discardsCount;
	  result += "<br>Is Locked: " + stat.isLocked;
	  //  result += "<br>" + xhttp.responseText
	  //result += "<\p>";
	  document.getElementById(target).innerHTML = result;

	  var hasCards = stat.cardCount > 0;
	  var isLocked = stat.isLocked;
	  document.getElementById("draw").disabled = !hasCards || isLocked;
	  document.getElementById("shuffle").disabled = isLocked;
	  document.getElementById("unlock").disabled = !isLocked;
	}

	function processActionResponseFun(xhttp, successCallback) {
	  return processActionResponse(xhttp, "requestResult", successCallback);
	}

	function processStatusResponseFun(xhttp) {
	  return processStatusResponse(xhttp, "status");
	}

	function justDisplayResponseFun(xhttp, target) {
	  return justDisplayResponse(xhttp, target);
	}

	function updateStatus() {
	  sendRequest("GET", allianceNavStatusPath, processStatusResponseFun);
	}

	function get(path) {
	  sendRequest("GET", path, processActionResponseFun, displayNavCard);
	}

	function post(path) {
	  sendRequest("POST", path, processActionResponseFun, justDisplayResponse);
	}

	function del(path) {
	  sendRequest("DELETE", path, processActionResponseFun, justDisplayResponse);
	}

	window.onload = function(e) {
	  hostPort = prompt("Please enter the host:port", "192.168.1.86:4567");
	  updateStatus();

	};

    </script>
</head>

<body>


<button id="draw" type="button" onclick="get(allianceNavPath)">Request nav card</button>
<button id="shuffle" type="button" onclick="post(allianceNavPath)">Shuffle</button>
<button id="lock" type="button" onclick="post(allianceNavLockPath)">lock</button>
<button id="unlock" type="button" onclick="del(allianceNavLockPath)">unlock</button>

<p>Result: <span id="requestResult"></span><br></p>
<p><span id="status"></span><br></p>
<p>Request id: <span id="requestId"></span><br></p>


</body>
</html>

