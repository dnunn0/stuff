<!DOCTYPE html>
<html>
<head>
    <style>
        .external {
            -moz-force-broken-image-icon: 1;
            <!-- put this here in the hopes of stopping flicker to no avail
            height: 100%;
            width: 13%;-->
            height: 250px;width: 140px;
                    }
         .button_image {
           -moz-force-broken-image-icon: 1;
        <!--    height: 100%;
            width: 75%;-->
            }
        .button_with_image {
            padding: 0;
            border: none;
            background: none;
         }
         .button_with_text {
            margin: 5% 0% 0% 0%;
            font-size: 5vw;
         }
         p {font-size: 4vw;}
         a {font-size: 4vw;}
         ol {font-size: 4vw;}
         td {text-align: center;}
         table {width:100%;margin: 3% 0% 0% 0%;}
         .less_on_top {margin-top: -10px;}
    </style>
    <title>Firefly</title>
    <script>
        var allianceNavDeck = "/alliance/nav";
        var navStatusPath = "/status";
        var navLockPath = "/lock";
        var hostPort = location.hostname + ":" + location.port;

        var statusUrl="ws://" + hostPort + "/status";
        console.log(statusUrl);
        var webSocket = new WebSocket(statusUrl);
        webSocket.onmessage = function (msg) { updateStatus(msg); };
        webSocket.onclose = function () { console.log("WebSocket connection closed") }
        webSocket.onopen = function(e) {
        console.log("Connection established!");
        webSocket.send('update status');
    };

	function sendRequest(method, deck, path, callbackProcess, successCallback) {
	  var xhttp = new XMLHttpRequest();
	  xhttp.addEventListener("load", function(ev){callbackProcess(xhttp, deck, successCallback); });
	  xhttp.addEventListener("error", function(ev){updateElement(deck +"/"+"requestResult", true, "Request probably didn't get to server.");});

	  xhttp.open(method, getUrl(deck, path), true);
//	  xhttp.setRequestHeader("Authorize", "dm9yZGVsOnZvcmRlbA==");
	  xhttp.send();
	}

    function startWithSlash(text) {
      if ((text) && (!text.startsWith("/"))) text ="/"+text;
      return text;
    }

	function getUrl(deck, path) {
	    path = startWithSlash(path);
	    return "http://"+hostPort+ deck + path;
	}

	function getCardUrl(deck, cardName) {
	    cardName = startWithSlash(cardName);
	    return "http://"+hostPort+ deck + "Card" + cardName;
	}

	function updateElement(target, addEmphasis, newHtml) {
	  if (addEmphasis) newHtml = "<font color='red'>" + newHtml + "</font>";
	  document.getElementById(target).innerHTML = newHtml;
	}

	function processActionResponse(xhttp, deck, cardArea, responseStatusArea, successCallback) {
		switch (xhttp.status) {
		  case 200:
			successCallback(xhttp, deck, cardArea, responseStatusArea)
			break;
		  case 404:
			updateElement(deck +"/"+responseStatusArea, true, "Needs shuffling!");
			break;
		  case 409:
			updateElement(deck +"/"+responseStatusArea, true, "Locked!");
			break;
		  default:
			displayUnexpectedError(xhttp, deck, responseStatusArea);
		}
	}

	function displayUnexpectedError(xhttp, deck, target) {
		var result = "Unexpected error: ReadyState, status, text: " + xhttp.readyState + "- " + xhttp.status + "-" + xhttp.statusText + ".";
	    updateElement(deck +"/"+target, true, result);
	}
	
	function updateRequestId(xhttp, deck, shouldOverride) {
		var target = "requestId";
		if (shouldOverride || "" == document.getElementById(target).innerHTML)
			updateElement(target, false, xhttp.getResponseHeader("id"));
	}

	function justDisplayResponse(xhttp, deck, cardArea, responseStatusArea) {
	  var target = responseStatusArea;
	  var result = xhttp.responseText;
	  updateElement(deck +"/"+target, false, result);
	  updateRequestId(xhttp, deck, true);
	}

	function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
	
	function updateHistory(deck, card) {
	    var anchorText = deck.replace("/","");
	    anchorText = anchorText.replace("/nav", "");
	    anchorText = capitalizeFirstLetter(anchorText);
	    anchorText += "-"+card.action;
		var item = "<a href='"+getCardUrl(deck, cardPicName(card.action))+"' target='_blank'>"+ anchorText + "</a>";
		updateElement("history", false, "<li>"+item+"</li>" + document.getElementById("history").innerHTML);
	}

	function quoteMarkFor(text) {
	    var qm = '"';
	    if (text.includes(qm)) qm = "'";
	    return qm;
	 }

	 function preloadImage(url, callback)
    {
        var img=new Image();
        img.src=url;
        img.onload = callback;
    }

	function displayNavCard(xhttp, deck, cardArea, responseStatusArea) {
	  var target = cardArea;
	  var card = JSON.parse(xhttp.responseText);
	  var cardUrl = getCardUrl(deck, cardPicName(card.action));
      var qm = quoteMarkFor(card.action);
      var newHtml = "<img class='external' src='" + cardUrl +"'"
                + " alt="+qm+card.action+qm
                +"/>";
	  preloadImage(cardUrl, function() {
          updateElement("/nav/card", false, newHtml);
      });
	  updateRequestId(xhttp, deck, true);
	  updateHistory(deck, card);
	}

	function cardPicName(cardName) {
		return cardName.replace(/[^a-zA-Z]/g, "")+".png";
	}

	function processActionResponseFun(xhttp, deck, successCallback) {
	  return processActionResponse(xhttp, deck, "card", "requestResult", successCallback);
	}

	function get(deck, path) {
	  var newHtml = "<img class='external' src='" + getCardUrl(deck, cardPicName("back")) +"'"
				+ " alt='"+(deck.replace(/[^a-zA-Z]/g, " "))+"'"
				+"/>";
	  updateElement("/nav/card", false, newHtml);
	  sendRequest("GET", deck, path, processActionResponseFun, displayNavCard);
	}

	function post(deck, path) {
	  sendRequest("POST", deck, path, processActionResponseFun, justDisplayResponse);
	}

	function del(deck, path) {
	  sendRequest("DELETE", deck, path, processActionResponseFun, justDisplayResponse);
	}
	
	function clearHistory() {
		updateElement("history", false, "");
	}

    function getPageUrl() {
        return document.location.toString();
    }

    function updateStatus(msg) {
      //console.log("got update " + msg.data);
	  var stat = JSON.parse(msg.data);
	  var deck = stat.source;
	  var result = stat.remainingCardsCount +"/" + (stat.remainingCardsCount+stat.discardsCount);
	  result += "&nbsp;(" + stat.discardsCount +")";
//	  result += "&emsp;Is Locked: " + stat.isLocked;
	  updateElement(deck +"/status", false, result);

	  var hasCards = stat.remainingCardsCount > 0;
	  var isLocked = stat.isLocked;
	  document.getElementById(deck + "/drawBtn").disabled = !hasCards || isLocked;
	  document.getElementById(deck + "/shuffleBtn").disabled = hasCards || isLocked;
	  document.getElementById(deck + "/unlockBtn").disabled = !isLocked;
    }


	window.onload = function(e) {
	};

	;

    </script>
</head>

<body>
<table>
    <tr>
        <td><span id="/nav/card"><img src="/alliance/navCard/back.png" class='external'></span><br></td>
    </tr>
</table>

<table>
    <tr>
        <td>
            <button class="button_with_image" id="/alliance/nav/drawBtn" type="button"
                    onclick="get('/alliance/nav', '')">
                <img src="/alliance/navCard/back.png" -alt='Request Alliance Nav card' class="button_image"/>
            </button>
        </td>
        <td>
            <button class="button_with_image" id="/border/nav/drawBtn" type="button" onclick="get('/border/nav', '')">
                <img src="/border/navCard/back.png" -alt='Request Border Nav card' class="button_image"/>
            </button>
        </td>
        <td>
            <button class="button_with_image" id="/rim/nav/drawBtn" type="button" onclick="get('/rim/nav', '')">
                <img src="/rim/navCard/back.png" -alt='Request Rim Nav card' class="button_image"/>
            </button>
        </td>
    </tr>
    <tr>
        <td>
            <p class="less_on_top"><span id="/alliance/nav/status"></span></p>
        </td>
        <td>
            <p class="less_on_top"><span id="/border/nav/status"></span></p>
        </td>
        <td>
            <p class="less_on_top"><span id="/rim/nav/status"></span></p>
        </td>
    </tr>
    <tr>
        <td>
            <button id="/alliance/nav/lockBtn" class="button_with_text" type="button"
                    onclick="post('/alliance/nav', navLockPath)">Lock Deck
            </button>
            <button id="/alliance/nav/unlockBtn" class="button_with_text" type="button"
                    onclick="del('/alliance/nav', navLockPath)">Unlock Deck
            </button>
        </td>
        <td>
            <button id="/border/nav/lockBtn" class="button_with_text" type="button"
                    onclick="post('/border/nav', navLockPath)">Lock Deck
            </button>
            <button id="/border/nav/unlockBtn" class="button_with_text" type="button"
                    onclick="del('/border/nav', navLockPath)">Unlock Deck
            </button>
        </td>
        <td>
            <button id="/rim/nav/lockBtn" class="button_with_text" type="button"
                    onclick="post('/rim/nav', navLockPath)">Lock Deck
            </button>
            <button id="/rim/nav/unlockBtn" class="button_with_text" type="button"
                    onclick="del('/rim/nav', navLockPath)">Unlock Deck
            </button>
        </td>
    </tr>
    <tr>
        <td>
            <button id="/alliance/nav/shuffleBtn" class="button_with_text" type="button"
                    onclick="post('/alliance/nav', '')">Shuffle
            </button>
        </td>
        <td>
            <button id="/border/nav/shuffleBtn" class="button_with_text" type="button"
                    onclick="post('/border/nav', '')">Shuffle
            </button>
        </td>
        <td>
            <button id="/rim/nav/shuffleBtn" class="button_with_text" type="button" onclick="post('/rim/nav', '')">
                Shuffle
            </button>
        </td>
    </tr>
    <tr>
        <td>
            <p><span id="/alliance/nav/requestResult"></span></p>
        </td>
        <td>
            <p><span id="/border/nav/requestResult"></span></p>
        </td>
        <td>
            <p><span id="/rim/nav/requestResult"></span></p>
        </td>
    </tr>
</table>

<br>


<button id="historyBtn" class="button_with_text" type="button" onclick="clearHistory()">Clear History</button>
<p>History
<ol class="less_on_top"><span id="history"></span></ol>
</p>
<p>Request id: <span id="requestId"/><br></p>


</body>
</html>

