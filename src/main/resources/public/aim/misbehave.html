<!DOCTYPE html>
<html>
<head>
    <style>
        .external {
            -moz-force-broken-image-icon: 1;
        }
    </style>
    <title>Firefly</title>
    <script>
    var allianceNavDeck = "/alliance/nav";
	var navStatusPath = "/status";
	var navLockPath = "/lock";
	var hostPort = "host:port";

	function sendRequest(method, deck, path, callbackProcess, successCallback) {
	  var xhttp = new XMLHttpRequest();
	  xhttp.addEventListener("load", function(ev){callbackProcess(xhttp, deck, successCallback); });
	  xhttp.addEventListener("error", function(ev){updateElement(deck +"/"+"requestResult", true, "Request probably didn't get to server.");});

	  xhttp.open(method, getUrl(deck, path), true);
//	  xhttp.setRequestHeader("Authorize", "dm9yZGVsOnZvcmRlbA==");
	  xhttp.send();
	}

	function getUrl(deck, path) {
	    if ((path) && (!path.startsWith("/"))) path ="/"+path;
	    return "http://"+hostPort+ deck + path;
	}

	function getCardUrl(deck, path) {
	    if ((path) && (!path.startsWith("/"))) path ="/"+path;
	    return "http://"+hostPort+ deck + "Card" + path;
	}

	function updateElement(target, addEmphasis, newHtml) {
	  if (addEmphasis) newHtml = "<font color='red'>" + newHtml + "</font>";
	  document.getElementById(target).innerHTML = newHtml;
	}

	function processActionResponse(xhttp, deck, target, successCallback) {
		switch (xhttp.status) {
		  case 200:
			successCallback(xhttp, deck, target)
			break;
		  case 404:
			updateElement(deck +"/"+target, true, "Needs shuffling!");
			break;
		  case 409:
			updateElement(deck +"/"+target, true, "Locked!");
			break;
		  default:
			displayUnexpectedError(xhttp, deck, target);
		}
		updateStatus(deck);

	}

	function processStatusResponse(xhttp, deck, target) {
	    switch (xhttp.status) {
	      case 200:
	        return updateDeckStatus(xhttp,deck, target);
	        break;
	      default:
	        displayUnexpectedError(xhttp, deck, target);
	    }
	}
	
	function displayUnexpectedError(xhttp, deck, target) {
		var result = "Unexpected error: ReadyState, status, text: " + xhttp.readyState + "- " + xhttp.status + "-" + xhttp.statusText + ".";
	    updateElement(deck +"/"+target, true, result);
	}
	
	function updateRequestId(xhttp, deck, shouldOverride) {
		var target = "requestId";
		if (shouldOverride || "" == document.getElementById(target).innerHTML)
			updateElement(target, false, xhttp.getResponseHeader("id"));
	}

	function justDisplayResponse(xhttp, deck, target) {
	  var result = xhttp.responseText;
	  updateElement(deck +"/"+target, false, result);
	  updateRequestId(xhttp, deck, true);
	}

	function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
	
	function updateHistory(deck, card) {
	    var anchorText = deck.replace("/","");
	    anchorText = anchorText.replace("/nav", "");
	    anchorText = capitalizeFirstLetter(anchorText);
	    anchorText += "-"+card.action;
		var item = "<a href='"+getCardUrl(deck, cardPicName(card))+"' target='_blank'>"+ anchorText + "</a>";
		updateElement("history", false, "<li>"+item+"</li>" + document.getElementById("history").innerHTML);
	}

	function quoteMarkFor(text) {
	    var qm = '"';
	    if (text.includes(qm)) qm = "'";
	    return qm;
	 }

	function displayNavCard(xhttp, deck, target) {
	  var card = JSON.parse(xhttp.responseText);
	  var qm = quoteMarkFor(card.action);
	  var newHtml = "<br><img class='external' src='" + getCardUrl(deck, cardPicName(card)) +"'"
				+ " alt="+qm+card.action+qm
				+ " height='320' width='220'"
				+"/>";
	  updateElement(deck +"/"+target, false, newHtml);
	  updateRequestId(xhttp, deck, true);
	  updateHistory(deck, card);
	}
	
	function cardPicName(card) {
		return card.action.replace(/[^a-zA-Z]/g, "")+".png";
	}

	function updateDeckStatus(xhttp, deck, target) {
	  var stat = JSON.parse(xhttp.responseText);
	  var result = "Cards Left: " + stat.remainingCardsCount;
	  result += "&emsp;Discards: " + stat.discardsCount;
	  result += "&emsp;Is Locked: " + stat.isLocked;
	  //  result += "<br>" + xhttp.responseText
	  //result += "<\p>";
	  updateElement(deck +"/"+target, false, result);
	  updateRequestId(xhttp, deck, false);

	  var hasCards = stat.remainingCardsCount > 0;
	  var isLocked = stat.isLocked;
	  document.getElementById(deck + "/drawBtn").disabled = !hasCards || isLocked;
	  document.getElementById(deck + "/shuffleBtn").disabled = isLocked;
	  document.getElementById(deck + "/unlockBtn").disabled = !isLocked;
	}

	function processActionResponseFun(xhttp, deck, successCallback) {
	  return processActionResponse(xhttp, deck, "requestResult", successCallback);
	}

	function processStatusResponseFun(xhttp, deck) {
	  return processStatusResponse(xhttp, deck,  "status");
	}

	function justDisplayResponseFun(xhttp,deck, target) {
	  return justDisplayResponse(xhttp, deck, target);
	}

	function updateStatus(deck) {
	  sendRequest("GET", deck, navStatusPath, processStatusResponseFun);
	}

	function get(deck, path) {
	  sendRequest("GET", deck, path, processActionResponseFun, displayNavCard);
	}

	function post(deck, path) {
	  sendRequest("POST", deck, path, processActionResponseFun, justDisplayResponse);
	}

	function del(deck, path) {
	  sendRequest("DELETE", deck, path, processActionResponseFun, justDisplayResponse);
	}
	
	function clearHistory() {
		updateElement("history", false, "");
	}

    function getPageUrl() {
        if (typeof this.href === "undefined")
            return document.location.toString().toLowerCase();

        return this.href.toString().toLowerCase();
    }

	window.onload = function(e) {
      var url = getPageUrl();
      var parts = url.split("/");
      hostPort = parts[2];
	  updateStatus(allianceNavDeck);

	};

    </script>
</head>

<body>


<button id="/alliance/nav/drawBtn" type="button" onclick="get(allianceNavDeck, '')">Request Alliance Nav card</button>
<button id="/alliance/nav/shuffleBtn" type="button" onclick="post(allianceNavDeck, '')">Shuffle</button>
<button id="/alliance/nav/lockBtn" type="button" onclick="post(allianceNavDeck, navLockPath)">Lock Deck</button>
<button id="/alliance/nav/unlockBtn" type="button" onclick="del(allianceNavDeck, navLockPath)">Unlock Deck</button>

<p><span id="/alliance/nav/requestResult"/><br></p>
<p><span id="/alliance/nav/status"/><br></p>

<button id="/border/nav/drawBtn" type="button" onclick="get('/border/nav', '')">Request Border Nav card</button>
<button id="/border/nav/shuffleBtn" type="button" onclick="post('/border/nav', '')">Shuffle</button>
<button id="/border/nav/lockBtn" type="button" onclick="post('/border/nav', navLockPath)">Lock Deck</button>
<button id="/border/nav/unlockBtn" type="button" onclick="del('/border/nav', navLockPath)">Unlock Deck</button>

<p><span id="/border/nav/requestResult"/><br></p>
<p><span id="/border/nav/status"/><br></p>

<button id="/rim/nav/drawBtn" type="button" onclick="get('/rim/nav', '')">Request Border Nav card</button>
<button id="/rim/nav/shuffleBtn" type="button" onclick="post('/rim/nav', '')">Shuffle</button>
<button id="/rim/nav/lockBtn" type="button" onclick="post('/rim/nav', navLockPath)">Lock Deck</button>
<button id="/rim/nav/unlockBtn" type="button" onclick="del('/rim/nav', navLockPath)">Unlock Deck</button>

<p><span id="/rim/nav/requestResult"/><br></p>
<p><span id="/rim/nav/status"/><br></p>


<button id="historyBtn" type="button" onclick="clearHistory()">Clear History</button>
<p>History
<ol style="margin-top:-10px;"><span id="history"/></ol>
</p>
<p>Request id: <span id="requestId"/><br></p>


</body>
</html>

