<!DOCTYPE html>
<html>
<head>
    <style>

         h1 {font-size: 3.5rem;}
         p {font-size: 3rem;}
         a {font-size: 3rem;}
         ol {font-size: 3rem;margin-bottom: 0.5rem;}
         td {text-align: center;}


        img {
            padding: 0;
            margin: 0;
            border:0;
        }


         /* table {width:100%;margin: 2.5rem 0% 0% 0%;border: 1px solid black;} */
          table {width:1200px;margin: 2.5rem 0% 0% 0%;}

         .less_on_top {margin-top: -10px;}
         .external_image {
           -moz-force-broken-image-icon: 1;
         }
          .logo_image {
             height: 1040px;width:1100px;
         }
         .large_card_image {
           height: 1040px;width: 715px;
         }
         .button_image {
            height: 480px;
            width: 330px;
         }
        .button_with_image {
            width:335px;
            padding: 0 0 0 0;
            border: none;
            background: none;
            margin: 0 100px 0 0;
         }
         button.button_with_image:disabled {
              opacity: 0.3;
        }
         .button_with_text_no_top_margin {
            font-size: 2.5rem;
         }
         .button_with_text {
            margin: 2.5rem 0rem 0rem 0rem;
            font-size: 2.5rem;
         }


    </style>
    <title>Firefly</title>
    <script>

        let hostPort = location.hostname + ":" + location.port;
        let isDrawing=false;

        setupStatus();
        let deck_al=new Deck("/alliance/nav");
        let deck_bo=new Deck("/border/nav");
        let deck_ri=new Deck("/rim/nav");
        let decks = new Map();
        decks.set("/alliance/nav", deck_al);
        decks.set("/border/nav", deck_bo);
        decks.set("/rim/nav", deck_ri);


    function Deck(navPath) {
       this.navPath=navPath;
       this.navLockPath=navPath+"/lock";
       this.nextDrawDisabledStatus=false;
    }
    Deck.prototype.getCardUrl = function (cardAction) {
        let cardName = cardAction.replace(/[^a-zA-Z]/g, "")+".png";
	    cardName = startWithSlash(cardName);
	    return "http://"+hostPort+ this.navPath + "Card" + cardName;
	}

    function setupStatus() {
        let statusUrl="ws://" + hostPort + "/status";
        let webSocket = new WebSocket(statusUrl);
        webSocket.onmessage = function (msg) { updateStatus(msg); };
        webSocket.onclose = function () { console.log("WebSocket connection closed ") }
        webSocket.onopen = function(e) {
            console.log("WebSocket connection open. Asking for status update. ");
            webSocket.send('update status');
        };
    }

	function sendRequest(method, deck, path, callbackProcess, successCallback) {
	  let xhttp = new XMLHttpRequest();
	  xhttp.addEventListener("load", function(ev){callbackProcess(xhttp, deck, successCallback); });
	  xhttp.addEventListener("error", function(ev){updateElement(deck.navPath +"/"+"requestResult", true, "Request probably didn't get to server.");});

	  xhttp.open(method, getUrl(path), true);
//	  xhttp.setRequestHeader("Authorize", "dm9yZGVsOnZvcmRlbA==");
	  xhttp.send();
	}

    function startWithSlash(text) {
      if ((text) && (!text.startsWith("/"))) text ="/"+text;
      return text;
    }

	function getUrl(path) {
	    path = startWithSlash(path);
	    return "http://"+hostPort+ path;
	}

	function updateElement(target, addEmphasis, newHtml) {
	  if (addEmphasis) newHtml = "<font color='red'>" + newHtml + "</font>";
	  document.getElementById(target).innerHTML = newHtml;
	}

	function processActionResponse(xhttp, deck, cardArea, responseStatusArea, successCallback) {
		switch (xhttp.status) {
		  case 200:
			successCallback(xhttp, deck, cardArea, responseStatusArea)
			break;
		  case 404:
			updateElement(deck.navPath +"/"+responseStatusArea, true, "Needs shuffling!");
			break;
		  case 409:
			updateElement(deck.navPath +"/"+responseStatusArea, true, "Locked!");
			break;
		  default:
			displayUnexpectedError(xhttp, deck, responseStatusArea);
		}
	}

	function displayUnexpectedError(xhttp, deck, target) {
		let result = "Unexpected error: ReadyState, status, text: " + xhttp.readyState + "- " + xhttp.status + "-" + xhttp.statusText + ".";
	    updateElement(deck.navPath +"/"+target, true, result);
	}

	function updateRequestId(id) {
		let target = "requestId";
        updateElement(target, false, id);
	}

	function justDisplayResponse(xhttp, deck, cardArea, responseStatusArea) {
	  let result = xhttp.responseText;
	  let target = responseStatusArea;
	  updateResponse(result, deck, responseStatusArea);
	  updateRequestId(xhttp.getResponseHeader("id"));
	}

    function updateResponse(response, deck, responseStatusArea) {
	  let target = responseStatusArea;
	  updateElement(deck.navPath +"/"+target, false, response);
	}

	function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

	function updateHistory(deck, card) {
	    let anchorText = deck.navPath.replace("/","");
	    anchorText = anchorText.replace("/nav", "");
	    anchorText = capitalizeFirstLetter(anchorText);
	    anchorText += "-"+card.action;
	    let cardUrl=deck.getCardUrl(card.action);
		let item = "<a href='"+cardUrl+"' target='_blank'>"+ anchorText + "</a>";
		updateElement("history", false, "<li>"+item+"</li>" + document.getElementById("history").innerHTML);
	}

	function quoteMarkFor(text) {
	    let qm = '"';
	    if (text.includes(qm)) qm = "'";
	    return qm;
	 }

    function sleep(timeToSleepMs) {
       return new Promise(resolve => setTimeout(resolve, timeToSleepMs));
   }

	function preloadImage(url, callback)
    {
        let img=new Image();
        img.src=url;
        img.onload = callback;
    }

    function forEachDeck(valueKeyMap){
         decks.forEach(valueKeyMap);
    }
    function disableDrawButtons() {
        forEachDeck(function(value, key, map) {
            let control = document.getElementById(key+"/drawBtn");
            control.disabled = true;
        });
    }

    function restoreDrawButtons() {
        forEachDeck(function(value, key, map) {
            let control = document.getElementById(key+"/drawBtn");
            control.disabled = value.nextDrawDisabledStatus;
        });
    }

	function displayNavCard(xhttp, deck, cardArea, responseStatusArea) {
	  let target = cardArea;
	  let card = JSON.parse(xhttp.responseText);
	  let cardUrl=deck.getCardUrl(card.action);
      let qm = quoteMarkFor(card.action);
      let newHtml = "<img class='external_image large_card_image' src='" + cardUrl +"'"
                + " alt="+qm+card.action+qm
                +"/>";
      let startOfWait = (new Date()).getTime();
	  preloadImage(cardUrl, async function() {
	      let teaseTime = 400;
	      let endOfWait = (new Date()).getTime();
	      let timeToSleep = Math.max(1, teaseTime - (endOfWait - startOfWait));
          await sleep(timeToSleep);

          updateElement("/nav/card", false, newHtml);
          await sleep(700);
          restoreDrawButtons();
          isDrawing=false;
      });
      updateResponse("&nbsp;", deck, responseStatusArea);
	  updateRequestId(xhttp.getResponseHeader("id"));
	  updateHistory(deck, card);
	}

	function processActionResponseFun(xhttp, deck, successCallback) {
	  return processActionResponse(xhttp, deck, "card", "requestResult", successCallback);
	}

	function drawCard(deck) {
	  isDrawing=true;
      disableDrawButtons();
      let cardUrl=deck.getCardUrl("back");
      let altText=(deck.navPath.replace(/[^a-zA-Z]/g, " "));
	  let newHtml = "<img class='external_image large_card_image' src='" + cardUrl +"'"
				+ " alt='"+altText+"'"
				+"/>";
	  updateElement("/nav/card", false, newHtml);
	  get(deck, deck.navPath, processActionResponseFun, displayNavCard);
	}

	function lock(deck) {
	  post(deck, deck.navLockPath, processActionResponseFun, justDisplayResponse);
	}

	function unlock(deck) {
	  del(deck, deck.navLockPath, processActionResponseFun, justDisplayResponse);
	}

	function shuffle(deck) {
	  if(confirm("Are you sure?")==true)
	     post(deck, deck.navPath, processActionResponseFun, justDisplayResponse);
	}


	function get(deck, path, processActionCallback, successCallback) {
	  sendRequest("GET", deck, path, processActionCallback, successCallback);
	}

	function post(deck, path, processActionCallback, successCallback) {
	  sendRequest("POST", deck, path, processActionCallback, successCallback);
	}

	function del(deck, path, processActionCallback, successCallback) {
	  sendRequest("DELETE", deck, path, processActionCallback, successCallback);
	}

	function clearHistory() {
		updateElement("history", false, "");
	}

    function getPageUrl() {
        return document.location.toString();
    }

    function updateStatus(msg) {
	  let stat = JSON.parse(msg.data);
	  let deckName = stat.source;
	  let result = stat.remainingCardsCount +"/" + (stat.remainingCardsCount+stat.discardsCount);
	  result += "&nbsp;(" + stat.discardsCount +")";
	  updateElement(deckName +"/status", false, result);

	  let hasCards = stat.remainingCardsCount > 0;
	  let isLocked = stat.isLocked;
	  decks.get(deckName).nextDrawDisabledStatus=!hasCards || isLocked;
	  if(!isDrawing) {
	      document.getElementById(deckName + "/drawBtn").disabled = decks.get(deckName).nextDrawDisabledStatus;
	  }
	  document.getElementById(deckName + "/shuffleBtn").disabled = hasCards || isLocked;
	  document.getElementById(deckName + "/unlockBtn").disabled = !isLocked;
    }


	window.onload = function(e) {
	};

	;



    </script>
</head>

<body>
<table>
    <tr>
        <td><span id="/nav/card"><img src="/SerenityLogo.png" class='external_image logo_image'></span><br></td>
    </tr>
</table>

<table>
    <tr id="drawActions">
        <td>
            <button class="button_with_image" id="/alliance/nav/drawBtn" type="button"
                    onclick="drawCard(deck_al)">
                <img src="/alliance/navCard/back.png" -alt='Request Alliance Nav card'
                     class="external_image button_image"/>
            </button>
        </td>
        <td>
            <button class="button_with_image" id="/border/nav/drawBtn" type="button"
                    onclick="drawCard(deck_bo)">
                <img src="/border/navCard/back.png" -alt='Request Border Nav card' class="external_image button_image"/>
            </button>
        </td>
        <td>
            <button class="button_with_image" id="/rim/nav/drawBtn" type="button"
                    onclick="drawCard(deck_ri)">
                <img src="/rim/navCard/back.png" -alt='Request Rim Nav card' class="external_image button_image"/>
            </button>
        </td>
    </tr>
    <tr>
        <td>
            <p class="less_on_top"><span id="/alliance/nav/status"></span>&emsp;&emsp;</p>
        </td>
        <td>
            <p class="less_on_top"><span id="/border/nav/status"></span>&emsp;&emsp;</p>
        </td>
        <td>
            <p class="less_on_top"><span id="/rim/nav/status"></span>&emsp;&emsp;</p>
        </td>
    </tr>
    <tr>
        <td>
            <p class="less_on_top"><span id="/alliance/nav/requestResult">&nbsp;</span></p>
        </td>
        <td>
            <p class="less_on_top"><span id="/border/nav/requestResult">&nbsp;</span></p>
        </td>
        <td>
            <p class="less_on_top"><span id="/rim/nav/requestResult">&nbsp;</span></p>
        </td>
    </tr>
    <tr>
        <td>
            <button id="/alliance/nav/lockBtn" class="button_with_text_no_top_margin" type="button"
                    onclick="lock(deck_al)">Lock Deck
            </button>
        </td>
        <td>
            <button id="/border/nav/lockBtn" class="button_with_text_no_top_margin" type="button"
                    onclick="lock(deck_bo)">Lock Deck
            </button>
        </td>
        <td>
            <button id="/rim/nav/lockBtn" class="button_with_text_no_top_margin" type="button"
                    onclick="lock(deck_ri)">Lock Deck
            </button>
        </td>
    </tr>
    <tr>
        <td>
            <button id="/alliance/nav/unlockBtn" class="button_with_text" type="button"
                    onclick="unlock(deck_al)">Unlock Deck
            </button>
        </td>
        <td>
            <button id="/border/nav/unlockBtn" class="button_with_text" type="button"
                    onclick="unlock(deck_bo)">Unlock Deck
            </button>
        </td>
        <td>
            <button id="/rim/nav/unlockBtn" class="button_with_text" type="button"
                    onclick="unlock(deck_ri)">Unlock Deck
            </button>
        </td>
    </tr>

    <tr>
        <td>
            <button id="/alliance/nav/shuffleBtn" class="button_with_text" type="button"
                    onclick="shuffle(deck_al)">Shuffle
            </button>
        </td>
        <td>
            <button id="/border/nav/shuffleBtn" class="button_with_text" type="button"
                    onclick="shuffle(deck_bo)">Shuffle
            </button>
        </td>
        <td>
            <button id="/rim/nav/shuffleBtn" class="button_with_text" type="button"
                    onclick="shuffle(deck_ri)">
                Shuffle
            </button>
        </td>
    </tr>

</table>

<br>


<button id="historyBtn" class="button_with_text" type="button" onclick="clearHistory()">Clear History</button>
<h1>History</h1>
<ol start="0" class="less_on_top"><span id="history"></span></ol>
</p>
<p>Request id: <span id="requestId"/><br></p>


</body>
</html>

